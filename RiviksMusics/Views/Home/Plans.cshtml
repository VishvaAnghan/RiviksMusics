@model IEnumerable<RiviksMusics.Models.PayNow>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Plans";
    Layout = "~/Views/Shared/_MusicLayout.cshtml";

    var FullName = "";
    var userEmail = "";
    var userPhoneNo = "";
    var isUserLoggedIn = User.Identity.IsAuthenticated;
    if (@UserManager.GetUserAsync(User).Result != null)
    {
        var user = @UserManager.GetUserAsync(User).Result;
        FullName = @UserManager.GetUserAsync(User).Result.FirstName + " " + @UserManager.GetUserAsync(User).Result.LastName;
        userEmail = @UserManager.GetUserAsync(User).Result.Email;
        userPhoneNo = @UserManager.GetUserAsync(User).Result.PhoneNo;
    }

    // var FullName1 = @UserManager.GetUserAsync(User).Result.FirstName + " " + @UserManager.GetUserAsync(User).Result.LastName;
    // var userEmail1 = @UserManager.GetUserAsync(User).Result.Email;
    // var userPhoneNo1 = @UserManager.GetUserAsync(User).Result.PhoneNo;
}

<link href="~/css/plan.css" rel="stylesheet" />
<body>


    <div class="plan">

        @foreach (var item in Model)
        {

            <div class="card " style="@item?.Style">
                
                <h1 class="card-title">@item?.PlanName </h1>
                <div class="card-body">
                    <div class="card-price" style="@item?.Style">
                        <p style="color:white">&#8377;<span class="card-price-value">@item?.Rupees</span><br /></p>
                    </div>
                    <div class="card-features">
                        <ul>
                            <li>@item?.Days Days </li>
                            <li>@item?.Duration</li>
                        </ul>
                    </div>

                    <button type="button" class="card-btn payBtn" data-id="@item?.PlanId">Buy Now</button>

                </div>
            </div>
        }


    </div>
</body>

<form asp-action="Payment" asp-controller="Plan" method="post" name="razorpayForm">
    <input id="razorpay_payment_id" type="hidden" name="razorpay_payment_id" />
    <input id="razorpay_order_id" type="hidden" name="razorpay_order_id" />
    <input id="razorpay_signature" type="hidden" name="razorpay_signature" />
    <input id="planId" type="hidden" name="planId" />
</form>


@section Scripts {
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        $(document).ready(function () {
            var isUserLoggedIn = @isUserLoggedIn.ToString().ToLower();
            function createOrder(planId) {

                $.ajax({
                    url: "@Url.Action("InitiateOrder", "Plan")",
                    dataType: "json",
                    data: { planId: planId },
                    success: function (resp) {
                        if (resp.status) {
                            $("#planId").val(planId);

                            setRazorPayOptions(resp.data)
                        } else {
                            alert(resp.message);
                        }
                    },
                    error: function (resp) {
                        console.log("Plan error:", resp);
                    }
                });
            }

            function setRazorPayOptions(orderId) {

                // var orderId = document.getElementById('razorpay_payment_id').value;

                var options = {
                    "name": "Riviks Musics",
                    "description": "Purchase Plan",
                    "order_id": orderId,
                    "image": "https://example.com/your_logo",
                    "prefill": {
                        "name": "@FullName",
                        "email": "@userEmail",
                        "contact": "@userPhoneNo",
                    },
                    "notes": {
                        "address": ""
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                }
                // Boolean whether to show image inside a white frame. (default: true)
                options.theme.image_padding = false;
                options.handler = function (response) {
                    document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
                    document.getElementById('razorpay_order_id').value = orderId;
                    document.getElementById('razorpay_signature').value = response.razorpay_signature;
                    document.razorpayForm.submit();
                };
                options.modal = {
                    ondismiss: function () {
                        console.log("This code runs when the popup is closed");
                    },
                    // Boolean indicating whether pressing escape key
                    // should close the checkout form. (default: true)
                    escape: true,
                    // Boolean indicating whether clicking translucent blank
                    // space outside checkout form should close the form. (default: false)
                    backdropclose: false
                };
                var rzp = new Razorpay(options);

                rzp.open();
                e.preventDefault();
            }

            $(".payBtn").click(function (e) {
                debugger
                e.preventDefault();
                if (!isUserLoggedIn ) {
                    window.location.href = '@Url.Action("Index", "Dashboard")';
                }
                else { 
                    createOrder($(this).attr("data-id"));
                }
            });


        })
    </script>

}